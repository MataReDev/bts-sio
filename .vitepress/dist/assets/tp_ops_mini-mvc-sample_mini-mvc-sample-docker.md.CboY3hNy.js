import{_ as e,c as a,o as i,U as s,k as n}from"./chunks/framework.aGaNZw_P.js";const b=JSON.parse('{"title":"Déployer Mini-MVC-Sample avec Docker","description":"Déployer Mini-MVC-Sample avec Docker","frontmatter":{"description":"Déployer Mini-MVC-Sample avec Docker"},"headers":[],"relativePath":"tp/ops/mini-mvc-sample/mini-mvc-sample-docker.md","filePath":"tp/ops/mini-mvc-sample/mini-mvc-sample-docker.md","lastUpdated":1702837966000}'),r={name:"tp/ops/mini-mvc-sample/mini-mvc-sample-docker.md"},l=s('<h1 id="deployer-mini-mvc-sample-avec-docker" tabindex="-1">Déployer Mini-MVC-Sample avec Docker <a class="header-anchor" href="#deployer-mini-mvc-sample-avec-docker" aria-label="Permalink to &quot;Déployer Mini-MVC-Sample avec Docker&quot;">​</a></h1><p>Dans le TP <a href="./deployer-mini-mvc-sample.html">Déployer Mini MVC Sample</a> nous avons vu comment déployer un site Mini MVC Sample directement sur la machine. Cette fois-ci nous allons voir comment le faire avec Docker.</p><div class="tip custom-block"><p class="custom-block-title">Docker ?</p><p>Vous débutez avec Docker ? Je vous conseille plutôt de <a href="./../../docker/introduction.html">démarrer par ici</a></p></div><details class="details custom-block"><summary>Sommaire</summary><nav class="table-of-contents"><ul><li><a href="#avant-propos">Avant-propos</a></li><li><a href="#votre-site-web">Votre site Web</a></li><li><a href="#dockeriser-votre-application">Dockeriser votre application</a><ul><li><a href="#creer-le-dockerfile">Créer le Dockerfile</a></li></ul></li><li><a href="#docker-compose-pret-a-deployer-sur-votre-serveur">Docker Compose : prêt à déployer sur votre serveur</a><ul><li><a href="#tester">Tester</a></li></ul></li><li><a href="#installer-docker-sur-votre-serveur-debian">Installer Docker sur votre serveur Debian</a></li><li><a href="#deployer-votre-site">Déployer votre site</a></li><li><a href="#mettre-a-jour-votre-site">Mettre à jour votre site</a></li><li><a href="#c-est-a-vous">C&#39;est à vous</a></li></ul></nav></details><h2 id="avant-propos" tabindex="-1">Avant-propos <a class="header-anchor" href="#avant-propos" aria-label="Permalink to &quot;Avant-propos&quot;">​</a></h2><p>Docker c&#39;est simple ! Les étapes peuvent paraître effrayante, mais non. Pour vous le prouver, voilà une vidéo de la procédure entière (2min top chrono de la création du projet à la mise à disposition sur votre machine) :</p>',6),t=n("iframe",{width:"560",height:"315",src:"https://www.youtube-nocookie.com/embed/CgEAJfltyuY",title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:""},null,-1),p=s(`<h2 id="votre-site-web" tabindex="-1">Votre site Web <a class="header-anchor" href="#votre-site-web" aria-label="Permalink to &quot;Votre site Web&quot;">​</a></h2><p>Pour tester (et pour être certains d&#39;avoir un projet propre), nous allons créer un nouveau projet. Mais bien évidemment, dans votre cas, vous utiliserez <strong>vos sources</strong> / <strong>votre projet.</strong></p><p><a href="https://github.com/c4software/mini-mvc-sample/archive/refs/tags/2.8.zip" target="_blank" rel="noreferrer">Télécharger un projet de démo</a></p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">php</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mvc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> serve</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Rendez-vous sur <a href="http://localhost:9000" target="_blank" rel="noreferrer">http://localhost:9000</a> votre site doit fonctionner correctement.</p><h2 id="dockeriser-votre-application" tabindex="-1">Dockeriser votre application <a class="header-anchor" href="#dockeriser-votre-application" aria-label="Permalink to &quot;Dockeriser votre application&quot;">​</a></h2><p>Maintenant que vous avez validé que votre application fonctionne correctement, nous allons la Dockeriser… La Dockeriser signifie finalement que nous allons la Packager pour pouvoir la déployer sur n&#39;importe quel serveur sans avoir à y installer autre chose que <code>Docker</code>.</p><h3 id="creer-le-dockerfile" tabindex="-1">Créer le Dockerfile <a class="header-anchor" href="#creer-le-dockerfile" aria-label="Permalink to &quot;Créer le Dockerfile&quot;">​</a></h3><p>Dockeriser une application requiert un nouveau fichier dans votre code source. Celui-ci doit se nommer <code>Dockerfile</code> je vous laisse créer à la racine de votre site (au même endroit que le <code>.env</code>) un fichier nommé <code>Dockerfile</code> avec comme contenu :</p><div class="language-dockerfile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> php:8.1.10-cli</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> docker-php-ext-install pdo_mysql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WORKDIR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /var/www/html</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">Dockerfile ?</p><p>Ce fichier contient l&#39;ensemble de la configuration pour que Mini-MVC-Sample fonctionne correctement. Il est en quelque sorte <strong>générique</strong> et pourra servir, quel que soit votre projet.</p><p>C&#39;est donc un outil très très pratique surtout avec ce que l&#39;on appelle des plateformes d&#39;intégration continue avec par exemple <strong>Gitlab-CI</strong>.</p></div><h2 id="docker-compose-pret-a-deployer-sur-votre-serveur" tabindex="-1">Docker Compose : prêt à déployer sur votre serveur <a class="header-anchor" href="#docker-compose-pret-a-deployer-sur-votre-serveur" aria-label="Permalink to &quot;Docker Compose : prêt à déployer sur votre serveur&quot;">​</a></h2><p>Vous avez maintenant « un serveur » qui fonctionne, nous allons ajouter un fichier nommé qui sera utilisé par Docker Compose, cette configuration au format YAML.</p><p>Docker Compose vas nous permet de créer de véritable environnement multi conteneur, dans notre cas pour l&#39;instant nous n&#39;aurons que Mini-MVC-Sample, mais qui peux le plus peux le moins.</p><p>Je vous laisse créer (dans le même dossier que le <code>Dockerfile</code>) un fichier nommé <code>docker-compose.yaml</code>, pour le contenu le voilà :</p><div class="language-dockerfile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">version: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;3&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">services:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  front:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    build: .</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    container_name: front</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    environment:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - MVC_SERVER=192.168.139.1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - MVC_DB=AP3_BD_HACKATHON_INITIAL</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - MVC_USER=VOTRE-UTILISATEUR-DE-BASE-DE-DONNEE</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - MVC_TOKEN=VOTRE-MOT-DE-PASSE</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - MVC_DEBUG=false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    command: php -S 0.0.0.0:9000</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    volumes:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - .:/var/www/html/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    restart: unless-stopped</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ports:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;8080:9000&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>Ce fichier indique que vous avez :</p><ul><li><strong>Un</strong> service.</li><li>Qui expose un port le <strong>8080</strong>. (accessible sur <code>http://votre.ip:8080</code>)</li><li>Qui (re)démarrera automatiquement au démarrage de le votre serveur.</li></ul><div class="tip custom-block"><p class="custom-block-title">Un instant ?</p><p>À votre avis :</p><ul><li>Quelles autres options avez-vous à votre disposition pour le restart ? <a href="https://docs.docker.com/config/containers/start-containers-automatically/" target="_blank" rel="noreferrer">C&#39;est par ici.</a></li><li>À quoi correspond &quot;8080:80&quot; ? Pourquoi avons-nous un <code>80</code> alors que le site est disponible sur le <code>8080</code> ?</li><li>Est-il possible de déclarer plusieurs services ? <a href="https://docs.docker.com/compose/compose-file/" target="_blank" rel="noreferrer">C&#39;est par ici.</a></li></ul></div><h3 id="tester" tabindex="-1">Tester <a class="header-anchor" href="#tester" aria-label="Permalink to &quot;Tester&quot;">​</a></h3><p>Pour tester, c&#39;est encore plus simple !</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> up</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Patientez quelques instants et votre site sera disponible sur le port <a href="http://localhost:8080" target="_blank" rel="noreferrer">http://localhost:8080</a>.</p><h2 id="installer-docker-sur-votre-serveur-debian" tabindex="-1">Installer Docker sur votre serveur Debian <a class="header-anchor" href="#installer-docker-sur-votre-serveur-debian" aria-label="Permalink to &quot;Installer Docker sur votre serveur Debian&quot;">​</a></h2><p>La procédure est assez similaire à l&#39;installation d&#39;un package classique :</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Ajout des éléments nécessaire à l&#39;installation</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt-get</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    ca-certificates</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    gnupg</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    lsb-release</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Ajout du dépôt permettant d&#39;installer Docker</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0755</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/apt/keyrings</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -fsSL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://download.docker.com/linux/debian/gpg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gpg</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --dearmor</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/apt/keyrings/docker.gpg</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;deb [arch=&quot;$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dpkg</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --print-architecture</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)&quot; signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian &quot;$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/os-release &amp;&amp; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$VERSION_CODENAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;)&quot; stable&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tee</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/apt/sources.list.d/docker.list</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/null</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Update la liste des packages et installation de Docker</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker-ce</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker-ce-cli</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd.io</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker-buildx-plugin</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker-compose-plugin</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>Félicitation,</strong> vous avez maintenant Docker sur votre Serveur.</p><div class="tip custom-block"><p class="custom-block-title">Un Instant !</p><p>À votre avis :</p><ul><li>D&#39;où viennent ces commandes ? <a href="https://docs.docker.com/engine/install/debian/" target="_blank" rel="noreferrer">Des informations</a></li><li>Pourquoi vous devez être vigilant quand vous copiez/collez des commandes ?</li></ul></div><h2 id="deployer-votre-site" tabindex="-1">Déployer votre site <a class="header-anchor" href="#deployer-votre-site" aria-label="Permalink to &quot;Déployer votre site&quot;">​</a></h2><p>Pour déployer votre site, il vous suffit :</p><ul><li>Envoyer le code source sur votre serveur (ftp, sftp, git au choix).</li><li>Lancer la commande :</li></ul><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> up</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">Un instant !</p><p>À votre avis ?</p><ul><li>Pouvez-vous modifier le port d&#39;écoute de votre serveur ? (oui, dans le, <code>docker-compose.yml</code> mais comment ?)</li><li>Est-ce que votre service va démarrer automatiquement si vous redémarrez votre machine ?</li></ul></div><h2 id="mettre-a-jour-votre-site" tabindex="-1">Mettre à jour votre site <a class="header-anchor" href="#mettre-a-jour-votre-site" aria-label="Permalink to &quot;Mettre à jour votre site&quot;">​</a></h2><p>Pour mettre à jour votre site, il vous suffit :</p><ul><li>Envoyer le code source sur votre serveur (ftp, sftp, git au choix).</li><li>Lancer la commande :</li></ul><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> compose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="c-est-a-vous" tabindex="-1">C&#39;est à vous <a class="header-anchor" href="#c-est-a-vous" aria-label="Permalink to &quot;C&#39;est à vous&quot;">​</a></h2><p>Je vous laisse ajouter une nouvelle page dans votre site. Une page avec les Conditions générales par exemple. Une fois cette page ajoutée, je vous laisse la mettre en ligne sur votre serveur.</p>`,39),o=[l,t,p];function c(h,d,k,u,m,v){return i(),a("div",null,o)}const F=e(r,[["render",c]]);export{b as __pageData,F as default};

import{_ as s,c as i,o as e,U as a}from"./chunks/framework.aGaNZw_P.js";const n="/assets/project_structure.kVAVG_xa.png",l="/assets/settings_cicd.CkvhNIZA.png",t="/assets/settings_cicd_variables.djKEKo9x.png",p="/assets/create_variable.BxO9qre3.png",r="/assets/variable_created._Ka0AQg4.png",v=JSON.parse(`{"title":"Livraison continue, Gitlab-CI + Kubernetes","description":"Nous avons vu que nous pouvions déployer une image Docker produite par Gitlab-CI « directement » dans un cluster Kubernetes. Dans ce TP nous allons voir comment il est possible d'automatiser ce (re)déploiement.","frontmatter":{"description":"Nous avons vu que nous pouvions déployer une image Docker produite par Gitlab-CI « directement » dans un cluster Kubernetes. Dans ce TP nous allons voir comment il est possible d'automatiser ce (re)déploiement."},"headers":[],"relativePath":"tp/ci/kubernetes/cd-avec-kubernetes.md","filePath":"tp/ci/kubernetes/cd-avec-kubernetes.md","lastUpdated":1640902682000}`),o={name:"tp/ci/kubernetes/cd-avec-kubernetes.md"},h=a('<h1 id="livraison-continue-gitlab-ci-kubernetes" tabindex="-1">Livraison continue, Gitlab-CI + Kubernetes <a class="header-anchor" href="#livraison-continue-gitlab-ci-kubernetes" aria-label="Permalink to &quot;Livraison continue, Gitlab-CI + Kubernetes&quot;">​</a></h1><p><a href="./deploy-container-in-kubernetes.html">Dans le précédent TP</a> nous avons vu que nous pouvions déployer une image Docker produite par Gitlab-CI « directement » dans un cluster Kubernetes. Dans ce TP nous allons voir comment il est possible d&#39;automatiser ce (re)déploiement.</p><details class="details custom-block"><summary>Sommaire</summary><nav class="table-of-contents"><ul><li><a href="#introduction">Introduction</a></li><li><a href="#le-retour-de-la-question-«-on-commit-la-configuration-»">Le retour de la question « On commit la configuration ? »</a></li><li><a href="#mise-en-place-du-ci-cd">Mise en place du CI/CD</a></li><li><a href="#authentification-aka-comment-se-connecter-a-votre-serveur-depuis-la-ci">Authentification (aka comment se connecter à votre serveur depuis la CI)</a><ul><li><a href="#creation-de-la-variable">Création de la variable</a></li></ul></li><li><a href="#configuration-et-variable-dans-la-ci">Configuration et variable dans la CI</a><ul><li><a href="#modifier-le-deployment-yaml">Modifier le deployment.yaml</a></li></ul></li><li><a href="#_3-etapes">3 étapes</a><ul><li><a href="#la-commande-sed">La commande sed</a></li><li><a href="#determiner-les-actions-de-deploiement">Déterminer les actions de déploiement</a></li><li><a href="#solution-alternative">Solution alternative</a></li></ul></li><li><a href="#un-resultat-possible">Un résultat possible</a></li><li><a href="#image-multi-architectures">Image multi-architectures ?</a></li><li><a href="#deployer-dans-un-cluster-«-prives-»">Déployer dans un cluster « privés »</a></li></ul></nav></details><h2 id="introduction" tabindex="-1">Introduction <a class="header-anchor" href="#introduction" aria-label="Permalink to &quot;Introduction&quot;">​</a></h2><p>Vous avez remarqué dans <a href="./deploy-container-in-kubernetes.html">le TP d&#39;initiation à Kubernetes</a> qu&#39;après la construction du cluster, les déploiements <strong>étaient très simple</strong> et que finalement il se résume à :</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deployment.yaml</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Nous allons voir que finalement le mettre dans d&#39;un flow de CI/CD ça ne sera finalement pas si compliqué.</p><div class="warning custom-block"><p class="custom-block-title">Auto devops ?</p><p>Quand on débute, l&#39;option auto devops de Gitlab est tentante. Elle est en effet très intéressante, car elle est plutôt clef en main… <strong>cependant</strong>, je pense que pour un débutant c&#39;est encore plus intéressant de comprendre comment ça fonctionne réellement.</p><p>D&#39;autant plus que vous allez le voir, pour un cas simple comme celui que nous avons construit la configuration à mettre est vraiment <strong>très minimaliste</strong>.</p></div><h2 id="le-retour-de-la-question-«-on-commit-la-configuration-»" tabindex="-1">Le retour de la question « On commit la configuration ? » <a class="header-anchor" href="#le-retour-de-la-question-«-on-commit-la-configuration-»" aria-label="Permalink to &quot;Le retour de la question « On commit la configuration ? »&quot;">​</a></h2><p>Gros débat… Dans un projet privé pas de problème, cette configuration peut accompagner le projet… dans le cas d&#39;un projet « public » attention à ne pas commiter un YAML qui ferait référence à des informations privées / non destinée aux publiques (IP, port, …)</p><p>Nous sommes dans le cadre d&#39;un projet privé, nous allons commiter la configuration d&#39;autant plus qu&#39;il ne s&#39;agira que des fichiers suivants :</p><ul><li><code>deployment.yaml</code></li><li><code>services.yaml</code></li><li><code>ingress.yaml</code></li></ul><p>Un projet nommé <code>helm</code> existe également pour automatiser cette partie. Nous pourrions l&#39;utiliser, mais mon objectif est de rester très simple dans l&#39;approche.</p><div class="tip custom-block"><p class="custom-block-title">c&#39;est à vous !</p><p>Je vous laisse commiter la configuration dans un dossier <code>kubernetes</code> (par exemple) <strong>dans le dossier docs</strong>.</p><p>Dans mon cas ça donne :</p><p><img src="'+n+'" alt="structure" loading="lazy"></p></div><div class="danger custom-block"><p class="custom-block-title">ATTENTION PAS DE SECRET !</p><p>Vous noterez que je ne commit pas la partie contenant les secrets. En effet celle-ci sera présente dans notre projet évidemment ! Mais elle prendra la forme <strong>d&#39;une variable de type file secrète</strong> dans la partie configuration de votre projet gitlab.</p></div><h2 id="mise-en-place-du-ci-cd" tabindex="-1">Mise en place du CI/CD <a class="header-anchor" href="#mise-en-place-du-ci-cd" aria-label="Permalink to &quot;Mise en place du CI/CD&quot;">​</a></h2><p>Dans le TP précédent nous avons déjà initialisé dans notre projet la partie CI, en effet l&#39;image du projet est construite automatiquement, cette image est sauvegardée automatiquement dans le Registry Docker interne à Gitlab. Nous allons nous concentrer sur la partie qui nous intéresse à savoir :</p><ul><li>Quel(s) opération(s) nous devons faire lors de la mise à jour de notre Cluster ?</li><li>Quel(s) information(s) nous avons besoin pour échanger avec notre cluster (authentification, secret, registry, …) ?</li><li>Quel(s) commande(s) nous devons utiliser pour déployer notre application ?</li></ul><div class="warning custom-block"><p class="custom-block-title">C&#39;est à vous</p><p>Cette étape est importante dans le cadre de la mise en place d&#39;un déploiement continue. En effet, le déploiement continu est « juste » une automatisation des actions de livraison. Si vous savez comment livrer, vous saurez comment livrer en continu.</p><p>Avant de continuer… Je vous laisse donc réfléchir ! Je vous attends pour échanger sur votre réflexion.</p></div><div class="danger custom-block"><p class="custom-block-title">Une note importante</p><p>Dans notre <code>CI/CD</code>, et plus particulièrement dans la partie <code>CD</code> il s&#39;agit que de la partie déploiement / livraison. <strong>Nous partons du principe</strong> que le cluster est déjà en place et déjà fonctionnel, pour éviter de surcharger notre flow de CD.</p><p>Donc normalement :</p><ul><li>Votre cluster existe et est fonctionnel.</li><li>Votre cluster est capable de dialoguer avec votre Registry. (à discuter ensemble)</li><li>Il possède déjà une version de votre application complètement fonctionnelle.</li></ul></div><h2 id="authentification-aka-comment-se-connecter-a-votre-serveur-depuis-la-ci" tabindex="-1">Authentification (aka comment se connecter à votre serveur depuis la CI) <a class="header-anchor" href="#authentification-aka-comment-se-connecter-a-votre-serveur-depuis-la-ci" aria-label="Permalink to &quot;Authentification (aka comment se connecter à votre serveur depuis la CI)&quot;">​</a></h2><p>Nous l&#39;avons vu dens le point précédent, la première étape est d&#39;autoriser le dialogue entre Gitlab et votre Cluster Kubernetes.</p><p>Dans le précédent TP nous avons vu que l&#39;authentification était réaliser via un fichier <code>yaml</code> obtenu depuis le serveur qui contient le cluster. Nous devrons donc procéder de la même façon depuis GITLAB, le problème est que je vous ai dit que ce fichier <strong>devait rester privé</strong> vous ne devez jamais le commiter dans votre projet.</p><p>Les développeurs (Open-Source) de Gitlab ont pensé à tout. Vous avez dans les paramètres de votre projet la possibilité de mettre des variables, ces variables peuvent-être de deux types :</p><ul><li><code>string</code>, pour une variable simple type token, configuration, etc (Ex <code>$SERVER=&quot;https://url-de-staging.devotreprojet.fr&quot;</code>)</li><li><code>file</code>, représente le contenu de votre fichier, lors de l&#39;étape de CI/CD Gitlab va créer un fichier avec le contenu et déclarera une variable avec comme contenu le chemin vers le fichier en question. (Ex. <code>$KUBECONFIG=&quot;/private/mon_fichier_yaml_RANDOMID.yml&quot;</code>)</li></ul><p>La force des variables c&#39;est qu&#39;en plus d&#39;être souple (de par le type) elles sont également (re)définissables en fonction de l&#39;environnement. Pratique !</p><p>Pour configurer une variable, rendez-vous dans &quot;Settings &gt; CICD&quot; puis &quot;Variables&quot;.</p><p><img src="'+l+'" alt="Settings CI/CD" loading="lazy"></p><p>Puis</p><p><img src="'+t+'" alt="Variables CI/CD" loading="lazy"></p><h3 id="creation-de-la-variable" tabindex="-1">Création de la variable <a class="header-anchor" href="#creation-de-la-variable" aria-label="Permalink to &quot;Création de la variable&quot;">​</a></h3><p>Nous allons créer une variable de type <code>file</code> avec comme nom la variable attendue par <code>kubectl</code> à savoir <code>KUBECONFIG</code> :</p><p><img src="'+p+'" alt="Création de variables" loading="lazy"></p><p>Pour le contenu, je vous laisse prendre le contenu du fichier <code>YAML</code> (celui qui contient les secrets) sous <strong>mac</strong> c&#39;est aussi simple que <code>cat $KUBECONFIG | pbcopy -</code>.</p><p><img src="'+r+`" alt="Variable créée" loading="lazy"></p><div class="tip custom-block"><p class="custom-block-title">Et c&#39;est tout !</p><p>Cette étape de création de variables est l&#39;équivalent du <code>export KUBECONFIG=&quot;emplacement/de/votre/vosSecret.yaml&quot;</code>. Ça veut dire que dans notre flow de CI/CD nous n&#39;aurons rien de spécial à faire. En effet, comme précisé la variable de type <code>file</code> expose une variable avec l&#39;emplacement du fichier.</p></div><h2 id="configuration-et-variable-dans-la-ci" tabindex="-1">Configuration et variable dans la CI <a class="header-anchor" href="#configuration-et-variable-dans-la-ci" aria-label="Permalink to &quot;Configuration et variable dans la CI&quot;">​</a></h2><p>Notre authentification est maintenant effective, Gitlab-CI est maintenant capable de dialoguer avec notre Cluster Kubernetes. L&#39;étape suivante est la personnalisation du YAML, pourquoi ? En effet, si vous vous souvenez du précédent TP, nous devions indiquer manuellement l&#39;identifiant de l&#39;image à déployer. Exemple :</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># …</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  containers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">vuepress-test</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">registry.gitlab.com/vbrosseau/vuepress-kubernetes-deploy:bb2d2d0b</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # &lt;- Identifiant du build à déployer</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># …</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Nous devons donc trouver un moyen de le changer <strong>à chaque build</strong> (c&#39;est à dire commit donc). Gitlab-CI intègre un système de variable automatique avec plein d&#39;informations relatives au contexte de votre Build (<a href="https://docs.gitlab.com/ee/ci/variables/predefined_variables.html" target="_blank" rel="noreferrer">Plus d&#39;informations</a>). Dans cette énorme liste de variable, nous avons une variable qui va nous intéresser plus particulièrement <code>$CI_COMMIT_SHORT_SHA</code>. En effet si vous vous souvenez de votre fichier gitlab-ci c&#39;est la variable que nous avons utilisée par tagguer l&#39;image dans le Registry Gitlab.</p><p>Mais nous allons avoir un problème… En effet les fichiers <code>YAML</code> n&#39;acceptent pas les variables comme un simple script shell, nous allons devoir jouer d&#39;une petite astuce pour pouvoir le changer dynamiquement.</p><div class="danger custom-block"><p class="custom-block-title">Helm</p><p>L&#39;autre solution serait d&#39;utiliser <code>Helm</code>, en effet <code>Helm</code> permet de gérer ce genre de chose. <strong>Cependant</strong>, ici nous allons faire simple. Nous allons utiliser <code>sed</code>, ça sera suffisant pour faire notre livraison continue minimaliste.</p></div><h3 id="modifier-le-deployment-yaml" tabindex="-1">Modifier le <code>deployment.yaml</code> <a class="header-anchor" href="#modifier-le-deployment-yaml" aria-label="Permalink to &quot;Modifier le \`deployment.yaml\`&quot;">​</a></h3><p>Parlons de l&#39;outil <code>sed</code>, <code>sed</code> (éditeur de flux) est un programme permettant d&#39;appliquer différentes transformations prédéfinies à un flux séquentiel de données textuelles. Concrètement, <code>sed</code> lit des données d&#39;entrée ligne par ligne, modifie chaque ligne selon des règles spécifiées. Nous allons donc nous en servir pour modifier le fichier <code>deployment.yml</code> « à la volée » autrement dit, au moment où nous allons vouloir déployer.</p><p>Dans mon cas, j&#39;ai décidé de modifier mon fichier <code>deployment.yml</code> pour retirer <strong>l&#39;identifiant</strong> du build (hash) pour y mettre un texte que je vais remplacer via <code>sed</code>.</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">vuepress-test</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  replicas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      app</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">vuepress-test</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  template</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        app</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">vuepress-test</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      containers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">vuepress-test</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">registry.gitlab.com/VALEUR-D-AVANT/LE-LIEN-QUE-VOUS-AVIEZ-AVANT:{{CI_COMMIT_SHORT_SHA}}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      imagePullSecrets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gitlab-registry</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>Nous avons donc maintenant un fichier YAML presque dynamique… En effet celui-ci contient maintenant une valeur <code>(<code>{{CI_COMMIT_SHORT_SHA}}</code>)</code> que nous allons remplacer via <code>sed</code> directement à chaque exécution de la step sur Gitlab-CI.</p><div class="tip custom-block"><p class="custom-block-title">C&#39;est à vous</p><p>Je vous laisse modifier votre fichier en fonction de votre cas.</p></div><h2 id="_3-etapes" tabindex="-1">3 étapes <a class="header-anchor" href="#_3-etapes" aria-label="Permalink to &quot;3 étapes&quot;">​</a></h2><div class="tip custom-block"><p class="custom-block-title">Ce n&#39;est que de l&#39;automatisation</p><p>Je me répète, mais c&#39;est important à comprendre ! Le livraison continue n&#39;est vraiment pas un système magique, il s&#39;agit seulement d&#39;automatiser les actions que <strong>vous</strong> faites habituellement pour livrer votre application. Rien de plus rien de moins</p></div><h3 id="la-commande-sed" tabindex="-1">La commande sed <a class="header-anchor" href="#la-commande-sed" aria-label="Permalink to &quot;La commande sed&quot;">​</a></h3><p>L&#39;idée va être la suivante : « utiliser <code>sed</code> pour lui faire remplacer <code><code>{{CI_COMMIT_SHORT_SHA}}</code></code> par la valeur de <code>$CI_COMMIT_SHORT_SHA</code>. Pour ça nous pouvons utiliser <code>sed</code> de la façon suivante :</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./kubernetes/deployment.yaml</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;s/{{CI_COMMIT_SHORT_SHA}}/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$CI_COMMIT_SHORT_SHA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/g&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Cette commande va prendre le fichier de déploiement « type », remplacer</p><h3 id="determiner-les-actions-de-deploiement" tabindex="-1">Déterminer les actions de déploiement <a class="header-anchor" href="#determiner-les-actions-de-deploiement" aria-label="Permalink to &quot;Déterminer les actions de déploiement&quot;">​</a></h3><p>Maintenant que nous savons comment rendre dynamique notre déploiement, il faut maintenant assembler les commandes nécéssaire au bon déploiement de notre application. Nous avons déterminé ensemble que lors du déploiement nous faisions :</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./kubernetes/deployment.yaml</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;s/{{CI_COMMIT_SHORT_SHA}}/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$CI_COMMIT_SHORT_SHA</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/g&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./kubernetes/services.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apply</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./kubernetes/ingress.yaml</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Comme pour l&#39;étape de compilation, et de <code>dockerise</code>, nous allons utiliser un step Gitlab-CI. Cette étape aura besoin de la commande <code>kubectl</code>, je vous laisse chercher un peu, mais moi dans mon cas j&#39;ai utilisé l&#39;image <code>bitnami/kubectl:latest</code> qui dispose de l&#39;ensemble des commandes dont j&#39;ai besoin.</p><details class="details custom-block"><summary>Vous séchez ? Vous souhaitez de l&#39;aide ?</summary><p>Avez-vous vraiment cherchez ? Si oui… Voilà <strong>ma solution</strong> à <strong>ma problématique</strong> :</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Nécessite une variable nommée KUBECONFIG de type file avec le contenu de votre « secret » Kubernetes (kubeconfig-monCluster.yaml)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Sous Mac le contenu peut-être obtenu via cat $KUBECONFIG | pbcopy -</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Sous Linux le contenu peut-être obtenu via cat $KUBECONFIG | xclip -selection clipboard</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">publish_to_prod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bitnami/kubectl:latest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    entrypoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  stage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">publish</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">dockerise</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cat ./kubernetes/deployment.yaml | sed &quot;s/{{CI_COMMIT_SHORT_SHA}}/$CI_COMMIT_SHORT_SHA/g&quot; | kubectl apply -f -</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kubectl apply -f ./kubernetes/services.yaml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kubectl apply -f ./kubernetes/ingress.yaml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  only</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">master</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></details><h3 id="solution-alternative" tabindex="-1">Solution alternative <a class="header-anchor" href="#solution-alternative" aria-label="Permalink to &quot;Solution alternative&quot;">​</a></h3><p>L&#39;autre solution (merci <a href="https://kevin.riou.pro/" target="_blank" rel="noreferrer">Kevin RIOU</a>), est d&#39;utiliser la commande :</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> image</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> deployment/vuepress-test</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vuepress-test=registry.gitlab.com/vbrosseau/vuepress-kubernetes-deploy:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$CI_COMMIT_SHORT_SHA</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Celle-ci va remplacer l&#39;image lors du (re)déploiement avec celle que nous avons actuellement buildé.</p><p>Cette solution est préférable à celle du <code>sed</code> car elle permet d&#39;avoir une configuration toujours fonctionnelle dans notre fichier <code>yaml</code>.</p><h2 id="un-resultat-possible" tabindex="-1">Un résultat possible <a class="header-anchor" href="#un-resultat-possible" aria-label="Permalink to &quot;Un résultat possible&quot;">​</a></h2><p>Voilà l&#39;un des résultats possibles, exemple de configuration Pages + Docker + Kubernetes</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">stages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">build</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">deploy</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">publish</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">node:latest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  stage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">build</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">npm install</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">npm run build</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  artifacts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    paths</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">src/.vuepress/dist</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  only</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">master</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dockerise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker:19.03.12</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  stage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">deploy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">build</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  services</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker:19.03.12-dind</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  variables</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    IMAGE_TAG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker build -t $IMAGE_TAG .</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker push $IMAGE_TAG</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  only</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">master</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Nécessite une variable nommée KUBECONFIG de type file avec le contenu de votre « secret » Kubernetes (kubeconfig-monCluster.yaml)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Sous Mac le contenu peut-être obtenu via cat $KUBECONFIG | pbcopy -</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Sous Linux le contenu peut-être obtenu via cat $KUBECONFIG | xclip -selection clipboard</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">publish_to_prod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bitnami/kubectl:latest</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    entrypoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  stage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">publish</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">dockerise</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Décommenter pour autoriser le kubernetes à s&#39;authentifier pour pull l&#39;image docker</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # - kubectl create secret docker-registry gitlab-registry --docker-server=&quot;$CI_REGISTRY&quot; --docker-username=&quot;$CI_DEPLOY_USER&quot; --docker-password=&quot;$CI_DEPLOY_PASSWORD&quot; --docker-email=&quot;$GITLAB_USER_EMAIL&quot; -o yaml --dry-run=client | kubectl apply -f -</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cat ./kubernetes/deployment.yaml | sed &quot;s/{{CI_COMMIT_SHORT_SHA}}/$CI_COMMIT_SHORT_SHA/g&quot; | kubectl apply -f -</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kubectl apply -f ./kubernetes/services.yaml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kubectl apply -f ./kubernetes/ingress.yaml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  only</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">master</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><h2 id="image-multi-architectures" tabindex="-1">Image multi-architectures ? <a class="header-anchor" href="#image-multi-architectures" aria-label="Permalink to &quot;Image multi-architectures ?&quot;">​</a></h2><p>Vous souhaitez créer une image qui fonctionnera sur un Raspberry Pi, mais également sur une machine X86? C&#39;est possible, c&#39;est ce que l&#39;on appelle les « Multi-architectures. Nous sommes plus dans quelque chose d&#39;aussi simple qu&#39;avec l&#39;exemple précédent, mais vous pouvez le faire sans problème depuis Gitlab-CI ?</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dockerise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker:19.03.12</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  stage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">deploy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">build</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  services</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker:19.03.12-dind</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      command</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--experimental&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  variables</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    IMAGE_TAG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    DOCKER_DRIVER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">overlay2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    DOCKER_TLS_CERTDIR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    BUILDX_VERSION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v0.4.1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  before_script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apk add curl</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mkdir -p ~/.docker/cli-plugins</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">curl -sSLo ~/.docker/cli-plugins/docker-buildx https://github.com/docker/buildx/releases/download/$BUILDX_VERSION/buildx-$BUILDX_VERSION.linux-amd64</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">chmod +x ~/.docker/cli-plugins/docker-buildx</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker run --rm --privileged multiarch/qemu-user-static --reset -p yes</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker info</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker buildx create --use</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker buildx build --push --platform linux/arm/v8,linux/amd64 -t $IMAGE_TAG .</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  only</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">master</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="deployer-dans-un-cluster-«-prives-»" tabindex="-1">Déployer dans un cluster « privés » <a class="header-anchor" href="#deployer-dans-un-cluster-«-prives-»" aria-label="Permalink to &quot;Déployer dans un cluster « privés »&quot;">​</a></h2><p>Nous avons vu avec les précédents exemples qu&#39;il était relativement simple de déployer en continu un cluster Kubernetes du moment que celui-ci est accessible via Internet. C&#39;est un peu plus compliqué quand il s&#39;agit d&#39;un cluster « interne » / « privé », non forcément exposé sur Internet.</p><p>Pour répondre à cette problématique, vous pouvez utiliser le système de <a href="/tp/ci/gitlab/runner.html">runner privé de Gitlab-CI</a>. Pourquoi à votre avis ?</p><ul><li>Pour terminer ce TP, je vous propose de monter sur votre machine : <ul><li>Un cluster Kubernetes</li><li>Un Runner Gitlab</li><li>Un déploiement continue depuis gitlab.com</li></ul></li></ul>`,74),d=[h];function c(k,u,E,m,b,g){return e(),i("div",null,d)}const F=s(o,[["render",c]]);export{v as __pageData,F as default};

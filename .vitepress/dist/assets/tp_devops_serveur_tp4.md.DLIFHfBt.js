import{_ as s,a as e,b as i}from"./chunks/filezilla_clefs.DttB0Jlk.js";import{_ as a,c as n,o as l,U as r}from"./chunks/framework.aGaNZw_P.js";const t="/assets/git_strategie.CYcN3OJ9.png",p="/assets/filezilla-connexion.CPc2LEYm.jpg",f=JSON.parse('{"title":"TP4. Déployer (et redéployer) son code sur un serveur","description":"Dans ce TP nous allons voir comment déployer (et redéployer) son code sur un serveur.","frontmatter":{"description":"Dans ce TP nous allons voir comment déployer (et redéployer) son code sur un serveur."},"headers":[],"relativePath":"tp/devops/serveur/tp4.md","filePath":"tp/devops/serveur/tp4.md","lastUpdated":1704218918000}'),o={name:"tp/devops/serveur/tp4.md"},u=r('<h1 id="tp4-deployer-et-redeployer-son-code-sur-un-serveur" tabindex="-1">TP4. Déployer (et redéployer) son code sur un serveur <a class="header-anchor" href="#tp4-deployer-et-redeployer-son-code-sur-un-serveur" aria-label="Permalink to &quot;TP4. Déployer (et redéployer) son code sur un serveur&quot;">​</a></h1><details class="details custom-block"><summary>Sommaire</summary><nav class="table-of-contents"><ul><li><a href="#objectifs">Objectifs</a></li><li><a href="#qu-est-ce-qu-un-deploiement">Qu&#39;est-ce qu&#39;un déploiement ?</a></li><li><a href="#les-differentes-strategies-de-deploiement">Les différentes stratégies de déploiement</a><ul><li><a href="#deploiement-via-ftp">Déploiement via FTP</a></li><li><a href="#deploiement-via-ssh-sfpt">Déploiement via SSH (SFPT)</a></li><li><a href="#deploiement-avec-git">Déploiement avec Git</a></li></ul></li><li><a href="#le-contexte">Le contexte</a></li><li><a href="#configuration-du-serveur">Configuration du serveur</a></li><li><a href="#les-virtuals-hosts">Les virtuals hosts</a><ul><li><a href="#creer-les-dossiers">Créer les dossiers</a></li><li><a href="#creer-les-fichiers-de-configuration">Créer les fichiers de configuration</a></li><li><a href="#activer-les-sites-web">Activer les sites Web</a></li><li><a href="#desactiver-les-sites-web">Désactiver les sites Web</a></li><li><a href="#ecouter-sur-plusieurs-ports">Écouter sur plusieurs ports</a></li><li><a href="#redemarrer-apache">Redémarrer Apache</a></li></ul></li><li><a href="#deployer-le-portfolio">Déployer le portfolio</a><ul><li><a href="#utiliser-filezilla">Utiliser filezilla</a></li></ul></li><li><a href="#deployer-le-code-source-de-l-ap">Déployer le code source de l&#39;AP</a><ul><li><a href="#automatiser-le-deploiement">Automatiser le déploiement</a></li></ul></li><li><a href="#conclusion">Conclusion</a></li><li><a href="#ressources">Ressources</a></li></ul></nav></details><h2 id="objectifs" tabindex="-1">Objectifs <a class="header-anchor" href="#objectifs" aria-label="Permalink to &quot;Objectifs&quot;">​</a></h2><p>Dans ce TP nous allons voir comment déployer (et redéployer) son code sur un serveur. Avoir un serveur c&#39;est bien, mais pouvoir déployer son code dessus c&#39;est mieux ! Nous allons donc voir quelles stratégies nous pouvons mettre en place pour déployer facilement notre code sur un serveur.</p><h2 id="qu-est-ce-qu-un-deploiement" tabindex="-1">Qu&#39;est-ce qu&#39;un déploiement ? <a class="header-anchor" href="#qu-est-ce-qu-un-deploiement" aria-label="Permalink to &quot;Qu&#39;est-ce qu&#39;un déploiement ?&quot;">​</a></h2><p>Un déploiement est le fait d&#39;envoyer / déposer son code sur un serveur. Cela peut être un serveur de production, de test, de développement, etc. Le déploiement est une étape importante dans le développement d&#39;une application. En effet, il permet de tester son code sur un serveur, et de le déployer sur un serveur de production.</p><p>Dans votre vie de développeur, vous allez devoir déployer à de nombreuses reprises votre code sur un serveur. C&#39;est pourquoi il est important de bien comprendre comment cela fonctionne.</p><div class="tip custom-block"><p class="custom-block-title">Déploiement automatisé ?</p><p>En entreprise, le déploiement est généralement automatisé. Cela permet de déployer son code sur un serveur de manière transparente, c&#39;est ce que l&#39;on appelle le <strong>Continuous Deployment</strong>. C&#39;est un sujet très intéressant, mais qui dépasse le cadre de ce cours.</p><p>Nous traiterons de ce sujet plus en détail en 2ème année.</p></div><h2 id="les-differentes-strategies-de-deploiement" tabindex="-1">Les différentes stratégies de déploiement <a class="header-anchor" href="#les-differentes-strategies-de-deploiement" aria-label="Permalink to &quot;Les différentes stratégies de déploiement&quot;">​</a></h2><p>Il existe plusieurs stratégies de déploiement :</p><ul><li>Déploiement via FTP.</li><li>Déploiement via SSH (SFPT).</li><li>Déploiement avec Git.</li></ul><h3 id="deploiement-via-ftp" tabindex="-1">Déploiement via FTP <a class="header-anchor" href="#deploiement-via-ftp" aria-label="Permalink to &quot;Déploiement via FTP&quot;">​</a></h3><p>Le déploiement via FTP est une stratégie de déploiement très simple. Elle consiste à envoyer son code sur un serveur via FTP. C&#39;est une stratégie très simple, mais qui présente quelques inconvénients :</p><ul><li>Le code n&#39;est pas versionné.</li><li>Il n&#39;est pas possible de revenir en arrière.</li><li>Il n&#39;est pas possible de déployer une version précise du code.</li></ul><p>De plus, elle nécessite de mettre en place un serveur FTP sur le serveur, ce qui n&#39;est pas forcément le cas.</p><h3 id="deploiement-via-ssh-sfpt" tabindex="-1">Déploiement via SSH (SFPT) <a class="header-anchor" href="#deploiement-via-ssh-sfpt" aria-label="Permalink to &quot;Déploiement via SSH (SFPT)&quot;">​</a></h3><p>Le déploiement via SSH (autrement appelé SFTP) est une stratégie de déploiement également très répandue. Elle repose sur l&#39;utilisation du serveur SSH déjà présent sur votre serveur. En effet, le serveur SSH permet de commande une machine à distance (via la ligne de commande). Mais le serveur SSH permet aussi de transférer des fichiers, c&#39;est ce que l&#39;on appelle le SFTP (Secure File Transfer Protocol). Cette stratégie présente des avantages par rapport à la stratégie FTP :</p><ul><li>La sécurité : le SFTP utilise le protocole SSH, ce qui permet de chiffrer les échanges.</li><li>L&#39;absence de service supplémentaire à installer sur le serveur.</li></ul><p>Nous aborderons le SFTP plus en détail dans ce TP / TD.</p><h3 id="deploiement-avec-git" tabindex="-1">Déploiement avec Git <a class="header-anchor" href="#deploiement-avec-git" aria-label="Permalink to &quot;Déploiement avec Git&quot;">​</a></h3><p>Utiliser Git pour déployer son code est également une stratégie intéressante. En effet, même si GIT n&#39;est pas fait pour déployer son code, il est possible de détourner son fonctionnement pour déployer son code. Cette stratégie présente plusieurs avantages :</p><ul><li>Le code est versionné.</li><li>Il est possible de revenir en arrière.</li><li>Il est possible de déployer une version précise du code.</li></ul><p>Pour déployer son code avec Git, il faut que vous utilisiez un serveur Git distant (GitHub, GitLab, Bitbucket, etc.). Ensuite, il faudra autoriser votre serveur à se connecter à votre serveur distant (via SSH). Enfin, il faudra configurer votre serveur pour qu&#39;il puisse récupérer le code depuis votre serveur Git distant (<code>git clone</code>).</p><p>Nous pouvons résumer cette stratégie de déploiement avec le schéma suivant :</p><p><img src="'+t+`" alt="Déploiement avec Git" loading="lazy"></p><h2 id="le-contexte" tabindex="-1">Le contexte <a class="header-anchor" href="#le-contexte" aria-label="Permalink to &quot;Le contexte&quot;">​</a></h2><p>Dans ce TP, nous allons déployer <strong>deux</strong> sites sur un serveur :</p><ul><li>Votre portfolio.</li><li>Le code de votre AP.</li></ul><p>Pour déployer ces deux sites, nous allons utiliser deux stratégies différentes :</p><ul><li>Le déploiement via SFTP pour le portfolio.</li><li>Le déploiement avec Git pour l&#39;AP.</li></ul><h2 id="configuration-du-serveur" tabindex="-1">Configuration du serveur <a class="header-anchor" href="#configuration-du-serveur" aria-label="Permalink to &quot;Configuration du serveur&quot;">​</a></h2><p>Pour créer ce serveur, je vous propose d&#39;utiliser un modèle existant (<a href="./tp1alt.html">Voir support</a>).</p><p>Une fois votre serveur créé (et fonctionnel), vous devez pouvoir vous connecter à votre serveur via SSH. Pour cela, vous devez utiliser la commande suivante :</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> wget</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lsb-release</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-transport-https</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gnupg2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ca-certificates</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wget</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -O</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/apt/trusted.gpg.d/php.gpg</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://packages.sury.org/php/apt.gpg</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;echo &quot;deb https://packages.sury.org/php/ $(lsb_release -sc) main&quot; &gt; /etc/apt/sources.list.d/php.list&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Installer Apache + PHP</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> curl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> open-vm-tools</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apache2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> php8.2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> php8.2-fpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> php8.2-cli</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> php8.2-{bz2,curl,mbstring,intl,pdo,mysql,gd,xml}</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Activer PHP dans Apache</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a2enmod</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> proxy_fcgi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> setenvif</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rewrite</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> headers</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a2enconf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> php8.2-fpm</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Active  Apache</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apache2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apache2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Vérifier la version de PHP</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">php</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -v</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Affiche OK si le serveur web est accessible.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --head</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:80</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;HTTP/1.[01] [23]..&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Le serveur écoute bien sur le port 80.&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Aucun serveur en écoute sur le port 80.&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>Votre serveur doit être accessible depuis votre navigateur. Pour cela, vous devez utiliser l&#39;adresse IP de votre serveur.</p><h2 id="les-virtuals-hosts" tabindex="-1">Les virtuals hosts <a class="header-anchor" href="#les-virtuals-hosts" aria-label="Permalink to &quot;Les virtuals hosts&quot;">​</a></h2><p>Vu que nous allons déployer deux sites sur un seul serveur, nous allons utiliser les <strong>virtuals hosts</strong>. Les virtuals hosts permettent de définir plusieurs sites sur un seul serveur.</p><h3 id="creer-les-dossiers" tabindex="-1">Créer les dossiers <a class="header-anchor" href="#creer-les-dossiers" aria-label="Permalink to &quot;Créer les dossiers&quot;">​</a></h3><p>Nous allons créer deux dossiers dans <code>/var/www/html</code> :</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/www/siteA</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/www/siteB</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="creer-les-fichiers-de-configuration" tabindex="-1">Créer les fichiers de configuration <a class="header-anchor" href="#creer-les-fichiers-de-configuration" aria-label="Permalink to &quot;Créer les fichiers de configuration&quot;">​</a></h3><p>Nous allons maintenant créer deux fichiers de configuration pour nos deux sites Web. Nous allons les créer dans le dossier <code>/etc/apache2/sites-available/</code>.</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nano</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/apache2/sites-available/siteA.conf</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Dans ce fichier, nous allons mettre le code suivant :</p><div class="language-apache vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">apache</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">VirtualHost</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> *:8080</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    DocumentRoot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /var/www/siteA</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ErrorLog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${APACHE_LOG_DIR}/siteA-error.log</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    CustomLog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${APACHE_LOG_DIR}/siteA-access.log combined</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">VirtualHost</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Ensuite, nous allons créer le fichier de configuration pour le site B :</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nano</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/apache2/sites-available/siteB.conf</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Dans ce fichier, nous allons mettre le code suivant :</p><div class="language-apache vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">apache</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">VirtualHost</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> *:8181</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    DocumentRoot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /var/www/siteB</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ErrorLog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${APACHE_LOG_DIR}/siteB-error.log</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    CustomLog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${APACHE_LOG_DIR}/siteB-access.log combined</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">VirtualHost</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">qu&#39;observez-vous ?</p><p>Ici les deux fichiers de configuration sont très similaires. La seule différence est le port sur lequel le site est accessible. Nous avons donc deux sites Web qui sont accessibles sur deux ports différents.</p><p><img src="`+s+`" alt="VirtualHost" loading="lazy"></p><p>Vous pouvez voir que nous avons également configuré les logs d&#39;Apache. Nous avons donc deux fichiers de logs différents pour chaque site Web. Cela nous permet de savoir quel site Web a généré une erreur.</p></div><h3 id="activer-les-sites-web" tabindex="-1">Activer les sites Web <a class="header-anchor" href="#activer-les-sites-web" aria-label="Permalink to &quot;Activer les sites Web&quot;">​</a></h3><p>Nous avons créé deux fichiers de configuration, mais ils ne sont pas encore activés. Pour les activer, nous allons utiliser la commande <code>a2ensite</code> :</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a2ensite</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> siteA</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a2ensite</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> siteB</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">La commande ne fonctionne pas ?</p><p>Pour que la commande fonctionne vous devez être en <code>root</code> avec les variables d&#39;environnement chargée :</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">su</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></div><h3 id="desactiver-les-sites-web" tabindex="-1">Désactiver les sites Web <a class="header-anchor" href="#desactiver-les-sites-web" aria-label="Permalink to &quot;Désactiver les sites Web&quot;">​</a></h3><p>Si vous voulez désactiver un site Web, vous pouvez utiliser la commande <code>a2dissite</code> :</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a2dissite</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> siteA</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a2dissite</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> siteB</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Cette commande va supprimer le lien symbolique dans le dossier <code>/etc/apache2/sites-enabled/</code>.</p><h3 id="ecouter-sur-plusieurs-ports" tabindex="-1">Écouter sur plusieurs ports <a class="header-anchor" href="#ecouter-sur-plusieurs-ports" aria-label="Permalink to &quot;Écouter sur plusieurs ports&quot;">​</a></h3><p>Par défaut, Apache écoute sur le port 80. Nous allons donc modifier la configuration d&#39;Apache pour qu&#39;il puisse écouter sur plusieurs ports.</p><p>Pour cela, nous allons modifier le fichier <code>/etc/apache2/ports.conf</code> :</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nano</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/apache2/ports.conf</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Nous allons modifier la ligne suivante :</p><div class="language-apache vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">apache</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Listen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 80</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>En :</p><div class="language-apache vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">apache</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Listen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 80</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Listen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8080</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Listen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8888</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">ici nous avons</p><ul><li><code>Listen 80</code> : le port par défaut d&#39;Apache</li><li><code>Listen 8080</code> : le port sur lequel le site A est accessible</li><li><code>Listen 8888</code> : le port sur lequel le site B est accessible</li></ul><p>Si nous voulions ajouter un quatrième site Web, nous aurions donc ajouté une ligne <code>Listen 8282</code> dans le fichier <code>ports.conf</code>. Ou tout autre port libre sur le serveur.</p></div><h3 id="redemarrer-apache" tabindex="-1">Redémarrer Apache <a class="header-anchor" href="#redemarrer-apache" aria-label="Permalink to &quot;Redémarrer Apache&quot;">​</a></h3><p>Nous avons modifié la configuration d&#39;Apache, il faut donc redémarrer le service :</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apache2</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="deployer-le-portfolio" tabindex="-1">Déployer le portfolio <a class="header-anchor" href="#deployer-le-portfolio" aria-label="Permalink to &quot;Déployer le portfolio&quot;">​</a></h2><p>Pour déployer votre portfolio, nous allons utiliser la stratégie de déploiement via SFTP. Pour cela, nous allons utiliser le logiciel FileZilla. FileZilla est un logiciel de transfert de fichiers qui permet de se connecter à un serveur distant via SFTP (entre autres).</p><p>FileZilla est déjà installé sur votre machine. Vous pouvez le lancer en tapant <code>filezilla</code> dans votre menu démarrer. Pour vous connecter, vous devez renseigner les informations suivantes :</p><ul><li><strong>Host</strong> : l&#39;adresse IP du serveur</li><li><strong>Username</strong> : votre nom d&#39;utilisateur</li><li><strong>Port</strong> : 22 (le port SSH)</li></ul><p>Et pas de mot de passe… Et oui, nous avons configuré le serveur pour ne pas demander de mot de passe. Pour vous connecter, vous devez utiliser une <strong>clé SSH</strong>. Pour ça vous devez :</p><ul><li>Édition &gt; Paramètres &gt; Connexion&gt; SFTP &gt; Ajouter un fichier de clé.</li></ul><p><img src="`+e+'" alt="FileZilla" loading="lazy"><img src="'+i+'" alt="FileZilla" loading="lazy"></p><h3 id="utiliser-filezilla" tabindex="-1">Utiliser filezilla <a class="header-anchor" href="#utiliser-filezilla" aria-label="Permalink to &quot;Utiliser filezilla&quot;">​</a></h3><p>FileZilla vous permet de vous connecter à votre serveur, il est très simple d&#39;utilisation. Vous pouvez simplement glisser-déposer vos fichiers dans le dossier <code>/var/www/siteA</code> pour les envoyer sur le serveur.</p><p>Tout d&#39;abord, vous devez vous connecter à votre serveur. Pour cela, vous devez renseigner les informations suivantes :</p><ul><li><strong>Host</strong> : l&#39;adresse IP du serveur</li><li><strong>Username</strong> : votre nom d&#39;utilisateur</li><li><strong>Port</strong> : 22 (le port SSH)</li></ul><p>Et pas de mot de passe… Et oui, nous avons configuré le serveur pour ne pas demander de mot de passe. Pour vous connecter, vous devez utiliser une <strong>clé SSH</strong>. Les informations sont à renseigner dans la barre de menu en haut :</p><p><img src="'+p+`" alt="FileZilla" loading="lazy"></p><p>Vous êtes maintenant connecté à votre serveur !</p><p>Je vous laisse envoyer votre code sur le serveur (dans le dossier <code>/var/www/siteA</code>).</p><p>Une fois que vous avez envoyé votre code, vous pouvez tester votre site en vous rendant sur l&#39;adresse IP du serveur, sur le port 8080. Votre site doit être accessible.</p><h2 id="deployer-le-code-source-de-l-ap" tabindex="-1">Déployer le code source de l&#39;AP <a class="header-anchor" href="#deployer-le-code-source-de-l-ap" aria-label="Permalink to &quot;Déployer le code source de l&#39;AP&quot;">​</a></h2><p>J&#39;aime beaucoup l&#39;idée de travailler avec Git pour ce genre de situation. Vous pouvez créer un dépôt sur votre machine, et le cloner sur le serveur, puis continuer à travailler sur votre machine et puller les modifications régulièrement.</p><p>La procédure sera la suivante sur votre serveur :</p><ul><li>Installer Git : <code>apt install git</code>.</li><li>Créer un dépôt sur votre machine et le partager sur Github / Gitlab.</li><li>Cloner le dépôt sur le serveur : <code>git clone &lt;url&gt;</code>. (après avoir généré une clé SSH, et l&#39;avoir ajoutée à votre compte Github / Gitlab <a href="/cheatsheets/ssh-key/">voir la procédure</a>).</li><li>Travailler sur votre machine les pusher régulièrement</li><li>Puller les modifications sur le serveur.</li></ul><p>Voilà un exemple complet de procédure <strong>SUR LE SERVEUR</strong> :</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Installation de Git</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">apt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> git</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Générer une clé SSH SUR LE SERVEUR</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh-keygen</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Ajouter la clé SSH sur votre compte Github / Gitlab</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.ssh/id_rsa.pub</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # Va afficher la clé SSH dans le terminal pour que vous puissiez la copier / coller.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Création d&#39;un dossier pour le projet</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/www/siteB</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/www/siteB</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># clone du dépôt de votre projet, le . à la fin est important, il permet de cloner le dépôt dans le dossier courant (ici /var/www/siteB)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> git@gitlab.com:c4software/votre-projet-deja-existant.git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Vous pouvez maintenant travailler sur votre machine</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># et pusher les modifications régulièrement</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Pour puller les modifications</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/www/siteA</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pull</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">faignant ?</p><p>Et vu que nous sommes faignants, voici un script pour gérer les mises à jour. Créez un fichier <code>update.sh</code> dans le dossier de votre choix (dans votre dossier personnel de votre serveur), et mettez-y le code suivant :</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/www/siteB</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pull</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Vous pourrez lancer ce script avec la commande <code>./update.sh</code>. Attention, il faut que le script soit exécutable (<code>chmod +x update.sh</code>).</p></div><p>Je vous laisse tester la procédure sur votre serveur en déployant le code source de votre AP (qui doit être sur Github / Gitlab). Je suis disponible pour vous aider si vous avez des difficultés.</p><h3 id="automatiser-le-deploiement" tabindex="-1">Automatiser le déploiement <a class="header-anchor" href="#automatiser-le-deploiement" aria-label="Permalink to &quot;Automatiser le déploiement&quot;">​</a></h3><p>Je vous laisse mettre en place une procédure de déploiement automatique sur votre serveur. Nous avons à notre disposition plusieurs outils pour cela :</p><ul><li>Le CRON (qui permet de lancer des scripts à des moments précis).</li><li>L&#39;intégration continue (qui permet de lancer des scripts à chaque push sur le dépôt).</li></ul><p>Vous ne savez pas encore comment réaliser de l&#39;intégration continue… par contre, vous savez déjà comment utiliser le CRON. Je vous laisse donc mettre en place une procédure de déploiement automatique sur votre serveur en utilisant le CRON.</p><p>Je souhaite que le code source de votre projet soit mis à jour une fois par heure du lundi au vendredi. Pour vous aider vous pouvez utiliser un outil comme <a href="https://crontab-generator.org/" target="_blank" rel="noreferrer">Crontab generator</a>.</p><h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-label="Permalink to &quot;Conclusion&quot;">​</a></h2><p>Dans ce TP / TD, nous avons vu comment nous pouvons simplifier la gestion du déploiement de nos projets. Nous avons également déployé plusieurs sites Web sur un même serveur.</p><p>Ce TP est loin d&#39;être exhaustif, mais il vous permettra de vous familiariser avec Apache et le PHP. Si vous souhaitez une synthèse (sans commentaire) de ce TP, vous pouvez consulter le fichier suivant : <a href="/cheatsheets/serveur/debian-web.html">Debian Web.</a></p><h2 id="ressources" tabindex="-1">Ressources <a class="header-anchor" href="#ressources" aria-label="Permalink to &quot;Ressources&quot;">​</a></h2><ul><li><a href="https://httpd.apache.org/" target="_blank" rel="noreferrer">Apache</a></li><li><a href="https://www.php.net/" target="_blank" rel="noreferrer">PHP</a></li><li><a href="https://filezilla-project.org/" target="_blank" rel="noreferrer">FileZilla</a></li><li><a href="https://git-scm.com/" target="_blank" rel="noreferrer">Git</a></li><li><a href="/cheatsheets/ssh-key/">SSH</a></li><li><a href="/cheatsheets/serveur/debian-web.html">Debian Web</a></li></ul>`,104),d=[u];function c(h,k,m,v,g,b){return l(),n("div",null,d)}const C=a(o,[["render",c]]);export{f as __pageData,C as default};

import{_ as s,c as e,o as a,U as i}from"./chunks/framework.aGaNZw_P.js";const n="/assets/hybrid-ci.BSwMYv3_.png",t="/assets/run.BuG-bPnX.png",r="/assets/resultat.DhPhaPvE.png",l="/assets/telechargement.B8DJrz_F.png",p="/assets/runner.Cnkd191H.png",o="/assets/SjcOa.UYMYcTqW.png",C=JSON.parse('{"title":"Compiler une application hybride avec Gitlab-CI","description":"Dans ce TP vous allez mettre en place l’intégration continue sur votre Projet d’application hybride. Fini la prise de tête pour la compilation de votre application. Vous allez utiliser « une image Docker » au travers de GitLab-CI","frontmatter":{"description":"Dans ce TP vous allez mettre en place l’intégration continue sur votre Projet d’application hybride. Fini la prise de tête pour la compilation de votre application. Vous allez utiliser « une image Docker » au travers de GitLab-CI"},"headers":[],"relativePath":"tp/ci/ci-hybride.md","filePath":"tp/ci/ci-hybride.md","lastUpdated":1640902682000}'),c={name:"tp/ci/ci-hybride.md"},d=i(`<h1 id="compiler-une-application-hybride-avec-gitlab-ci" tabindex="-1">Compiler une application hybride avec Gitlab-CI <a class="header-anchor" href="#compiler-une-application-hybride-avec-gitlab-ci" aria-label="Permalink to &quot;Compiler une application hybride avec Gitlab-CI&quot;">​</a></h1><h2 id="introduction" tabindex="-1">Introduction <a class="header-anchor" href="#introduction" aria-label="Permalink to &quot;Introduction&quot;">​</a></h2><p>Dans ce TP vous allez mettre en place l’intégration continue sur votre Projet d’application hybride. Fini la prise de tête pour la compilation de votre application. Vous allez utiliser « une image Docker » au travers de GitLab-CI l’image docker en question est <a href="https://hub.docker.com/r/c4software/cordova-light/" target="_blank" rel="noreferrer">Cordova light</a>.</p><p>Pourquoi Light ? Car l’image n’embarque pas Chrome Headless, et donc ne permet pas de faire de test unitaire de votre application.</p><h2 id="creation-du-projet-sur-gitlab" tabindex="-1">Création du projet sur GitLab <a class="header-anchor" href="#creation-du-projet-sur-gitlab" aria-label="Permalink to &quot;Création du projet sur GitLab&quot;">​</a></h2><p>Avec votre compte GitLab vous pouvez créer un nombre illimité de projets. La première étape est donc de créer un projet sur votre <a href="https://gitlab.com/projects/new" target="_blank" rel="noreferrer">compte Gitlab</a>.</p><p>⚠️ Je vous conseille de mettre votre projet en mode « Private ».</p><h2 id="commiter-et-pusher-vos-sources" tabindex="-1">Commiter et Pusher vos sources <a class="header-anchor" href="#commiter-et-pusher-vos-sources" aria-label="Permalink to &quot;Commiter et Pusher vos sources&quot;">​</a></h2><p>Si ce n’est pas déjà fait, commiter les sources de votre application Cordova. Attention à bien mettre un <code>.gitignore</code> pour ignorer le dossier <code>nodes_modules/</code>.</p><p>Vous pouvez pusher vos sources.</p><h2 id="activer-gitlab-ci" tabindex="-1">Activer GitLab-CI <a class="header-anchor" href="#activer-gitlab-ci" aria-label="Permalink to &quot;Activer GitLab-CI&quot;">​</a></h2><p>Maintenant que votre projet est sur GitLab, nous allons activer Gitlab-CI. Pour ça créer un fichier <code>.gitlab-ci.yml</code>, c’est le fichier qui va activer l’intégration continue sur votre projet. Voilà le contenu du fichier :</p><div class="language-yml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">c4software/cordova-light</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">stages</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">deploy</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">cache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  untracked</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;$CI_PROJECT_ID&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  paths</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">plugins/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">android_debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  stage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">deploy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  when</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">manual</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cordova platform add android</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cordova build android</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  artifacts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    paths</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">platforms/android/build/outputs/apk/</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>Et c’est tout, avec ce simple fichier votre application est prête et sera compilée en automatique.</p><p>Commiter et Pusher la modification.</p><ul><li>Regarder les fichiers : <ul><li>À quoi correspond le <code>when: manual</code>?</li><li>À quoi sert le cache ?</li><li>À quoi correspond le <code>artifacts</code> ?</li></ul></li></ul><h2 id="lancement-d-un-«-build-»" tabindex="-1">Lancement d’un « Build » <a class="header-anchor" href="#lancement-d-un-«-build-»" aria-label="Permalink to &quot;Lancement d’un « Build »&quot;">​</a></h2><p>Pour lancer un build rendez-vous dans la partie « CI/CD » de votre Projet GitLab.</p><p><img src="`+n+'" alt="ci" loading="lazy"></p><p>Et lancer le build :</p><p><img src="'+t+'" alt="ci" loading="lazy"></p><p>Au bout de quelques minutes, votre application est prête :</p><p><img src="'+r+'" alt="resultat" loading="lazy"></p><p>Bonus !</p><p>Grâce à l’artifact votre application est même téléchargeable :</p><p><img src="'+l+'" alt="dl" loading="lazy"></p><h2 id="test-et-analyse" tabindex="-1">Test et analyse <a class="header-anchor" href="#test-et-analyse" aria-label="Permalink to &quot;Test et analyse&quot;">​</a></h2><p>Désactiver le « cache » dans le fichier Gitlab-ci. Tester de compiler plusieurs fois votre application. À votre avis le cache est-il utile ?</p><h2 id="declarer-un-runner-gitlab" tabindex="-1">Déclarer un runner GitLab <a class="header-anchor" href="#declarer-un-runner-gitlab" aria-label="Permalink to &quot;Déclarer un runner GitLab&quot;">​</a></h2><p>Comme nous l’avons vu tout repose sur les runners, de base Gitlab fournie des runners partagés. C’est runners sont pratique, car ils sont instantanément disponibles dans vos projets, cependant vu qu’ils sont partagés avec d’autres utilisateurs il peut rapidement y avoir des questions de sécurités et surtout de performances.</p><p>Pour être plus autonome (et plus performant) même dans la version cloud il est possible de déclarer un runners « à nous ». Ce runner va être dédié à votre compte, car il sera déclaré sur votre machine.</p><h3 id="installation" tabindex="-1">Installation <a class="header-anchor" href="#installation" aria-label="Permalink to &quot;Installation&quot;">​</a></h3><p>Pour déclarer un runner c’est très simple, il faut juste le lancer / l’installer sur votre machine. La documentation de GitLab étant très bien fait rendez-vous <a href="https://docs.gitlab.com/runner/install/windows.html" target="_blank" rel="noreferrer">ici pour Windows</a> et <a href="https://docs.gitlab.com/runner/install/linux-repository.html" target="_blank" rel="noreferrer">la pour Linux</a></p><h2 id="enregistrer-le-runner" tabindex="-1">Enregistrer le runner <a class="header-anchor" href="#enregistrer-le-runner" aria-label="Permalink to &quot;Enregistrer le runner&quot;">​</a></h2><p>Maintenant que le runner est installer sur votre machine, nous allons devoir l’enregistrer. L’enregistrement consiste à déclarer à Gitlab.com que votre machine est prête à exécuter des tâches. Vous dédiez en quelques sortes un peu de vos ressources à GitLab au travers de votre Runner.</p><p>L’enregistrement du runners est relativement simple, il faut dans un premier temps allez dans « les Paramètres CI/CD du projet que vous avez créé » exemple <code>https://gitlab.com/bts-sio-chevrollier/slam5/settings/ci_cd</code> cliquez sur « Expand » de la catégorie « Runners settings ». Vous devez avoir quelques chose comme :</p><p><img src="'+p+`" alt="Register Runner" loading="lazy"></p><p>Dans une console administrateur :</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./gitlab-runner.exe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> register</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>✋ STOP ! Une fois rendu à cette étape appeler moi ! Nous allons terminer la procédure ensemble. Pour les plus téméraires, vous pouvez suivre <a href="https://docs.gitlab.com/runner/register/index.html#windows" target="_blank" rel="noreferrer">la documentation</a> (attention à bien choisir Docker)</p><h2 id="signer-l-application" tabindex="-1">Signer l’application <a class="header-anchor" href="#signer-l-application" aria-label="Permalink to &quot;Signer l’application&quot;">​</a></h2><p>Faire du Debug c’est bien ! Mais si on faisait une application prête pour le Store ? C’est possible et tout aussi simplement.</p><p>⚠️ Je vous déconseille fortement de le faire sur un « runner » public de Gitlab-CI. Pourquoi ? Simplement, car nous allons mettre une clé de signature sur votre APK, clé qui doit rester <strong>PRIVÉE</strong> ! C’est ce qui garantit la sécurité de votre application, si celle-ci se retrouve en ligne le jeu est fini pour vous n’importe qui peut usurper votre identité.</p><p>Ajouter dans le fichier <code>.gitlab-ci.yml</code></p><div class="language-yml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">android</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  stage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">deploy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  when</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">manual</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  script</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cordova platform add android</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cordova build android --release -- --keystore=&quot;keystore/keyfile&quot; --keystoreType jks --password=&quot;MOT_DE_PASSE&quot; --storePassword=&quot;MOT_DE_PASSE&quot; --alias=&quot;demo&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  artifacts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    paths</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">platforms/android/build/outputs/apk/</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>Comme vous pouvez le constater, la partie script fait référence à un nouveau fichier le <code>keystore/keyfile</code>. Pour que la commande fonctionne, nous allons donc devoir « le créer ».</p><h3 id="creation-du-keystore" tabindex="-1">Création du keystore <a class="header-anchor" href="#creation-du-keystore" aria-label="Permalink to &quot;Création du keystore&quot;">​</a></h3><p>Le Keystore est une notion d’Android, rien à voir avec Cordova. Il faut donc utiliser Android-Studio (pour les intéressés il est également possible de le faire avec la ligne de commande).</p><p>Avec Android Studio :</p><p><img src="`+o+`" alt="store" loading="lazy"></p><p>Une fois créé :</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -A</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> commit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -am</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Ajout signature&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> push</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="lancement-d-un-build" tabindex="-1">Lancement d’un build <a class="header-anchor" href="#lancement-d-un-build" aria-label="Permalink to &quot;Lancement d’un build&quot;">​</a></h3><p>Relancer un build, mais en sélectionnant le stage « android ». Au bout de quelques minutes, vous devez obtenir une application signée.</p>`,54),u=[d];function h(k,m,b,g,E,v){return a(),e("div",null,u)}const F=s(c,[["render",h]]);export{C as __pageData,F as default};
